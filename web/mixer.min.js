'use strict';const channelsDiv=document.getElementById("channels"),auxSelect=document.getElementById("aux"),panCheckbox=document.getElementById("panning"),auxiliaries=document.getElementById("auxiliaries"),snapshot=document.getElementById("snapshot");let ws=null,timeout=null,channelInputs=null,panInputs=null;function sliderToDb(a){a=Math.log(100*a)/Math.log(100)*100-90;return-Infinity===a?-150:a}function dbToSlider(a){return Math.pow(100,(a+90)/100)/100}
function sliderChange(a){a=parseFloat(this.value);this.parentNode.style.setProperty("--value",100*a+"%");if(ws){var b="level";this.classList.contains("volumeInput")&&(a=sliderToDb(a));this.classList.contains("panInput")&&(b="pan");sendOSC("/Input_Channels/"+this.dataset.channel+"/Aux_Send/"+auxSelect.options[auxSelect.selectedIndex].dataset.channel+"/send_"+b,[a])}}function sendOSC(a,b=[]){ws.send(JSON.stringify({address:a,args:b}))}
function requestValues(){for(let a=1;a<=[...document.getElementsByClassName("volumeInput")].length;a++)sendOSC("/Input_Channels/"+a+"/Aux_Send/"+auxSelect.options[auxSelect.selectedIndex].value+"/send_level/?"),sendOSC("/Input_Channels/"+a+"/Aux_Send/"+auxSelect.options[auxSelect.selectedIndex].value+"/send_pan/?")}
function onMessage(a){a=JSON.parse(a.data);if(a.config)snapshot.innerText=a.config.snapshot,buildAux(a.config.aux),buildChannels(a.config.channels),auxSelect.dispatchEvent(new Event("change"));else{"/SnapshotName"==a.address&&(snapshot.innerText=a.args[0]);var b=a.address.match(/^\/Input_Channels\/([0-9]+)\/Aux_Send\/([0-9]+)\/send_level$/);null!==b&&b[2]==auxSelect.options[auxSelect.selectedIndex].dataset.channel&&(b=channelInputs[b[1]-1],b.value=dbToSlider(parseFloat(a.args[0])),b.parentNode.style.setProperty("--value",
100*b.value+"%"));b=a.address.match(/^\/Input_Channels\/([0-9]+)\/Aux_Send\/([0-9]+)\/send_pan$/);null!==b&&b[2]==auxSelect.options[auxSelect.selectedIndex].dataset.channel&&(b=panInputs[b[1]-1],b.value=a.args[0],b.parentNode.style.setProperty("--value",100*b.value+"%"));b=a.address.match(/^\/Input_Channels\/([0-9]+)\/Channel_Input\/name$/);if(null!==b)for(var c of document.querySelectorAll('input[data-channel="'+b[1]+'"]'))c.previousElementSibling.innerHTML=a.args[0];c=a.address.match(/^\/Aux_Outputs\/([0-9]+)\/Buss_Trim\/name$/);
if(null!==c){for(let d of auxSelect.options)d.value==c[1]&&(d.innerHTML=a.args[0],auxSelect.previousElementSibling.innerHTML=auxSelect.getElementsByTagName("option")[auxSelect.selectedIndex].text);for(let d of auxiliaries.getElementsByTagName("button"))if(d.value==c[1]){d.lastChild.nodeValue=a.args[0];break}}}}function formatColour(a){return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)].join():null}
function buildAux(a){let b="";auxiliaries.innerHTML="";for(let e of a)if(e.enabled){var c=e.icon?e.icon:"",d=formatColour(e.colour);b+='<option value="'+e.channel+'" data-channel="'+e.channel+'" data-colour="'+d+'" data-stereo="'+e.stereo+'" data-icon="'+c+'">'+e.label+"</option>";a=document.createElement("button");a.value=e.channel;a.style.setProperty("--tint",d);d=document.createElement("img");d.src=c;d.width=30;d.height=30;a.appendChild(d);c=document.createTextNode(e.label);a.appendChild(c);auxiliaries.appendChild(a)}else localStorage.getItem("aux")==
e.channel&&localStorage.removeItem("aux");auxSelect.innerHTML=b;localStorage.getItem("aux")?auxSelect.value=localStorage.getItem("aux"):document.body.classList.add("auxPicker")}function auxMouseDown(a){a.preventDefault();a.stopImmediatePropagation();document.body.classList.add("auxPicker")}auxSelect.addEventListener("mousedown",auxMouseDown);
function auxPickerClick(a){"BUTTON"==a.target.nodeName&&(auxSelect.value=a.target.value,auxSelect.dispatchEvent(new Event("change")),document.body.classList.remove("auxPicker"))}auxiliaries.addEventListener("click",auxPickerClick);let tapedTwice=!1;function tapSlider(a){if(!tapedTwice)return tapedTwice=!0,setTimeout(function(){tapedTwice=!1},300),!1;resetSlider(a)}
function resetSlider(a){a.target.classList.contains("volumeInput")&&(a.target.value=0);a.target.classList.contains("panInput")&&(a.target.value=.5);a.target.dispatchEvent(new Event("input"))}
function buildChannels(a){let b="";for(let c of a)""!=c.title&&(b+='<h2 style="order:'+c.order+'">'+c.title+"</h2>"),b+="<div"+(c.enabled?"":' class="disabled"')+' style="order:'+c.order+'">',b+='<label class="volume">',""!=c.icon&&(b+='<img src="'+c.icon+'" width="22" height="22" class="icon" />'),b+="<span>"+c.label+'</span><input type="range" data-channel="'+c.channel+'" class="volumeInput" step="0.001" min="0" max="1" value="0" /></label>',b+='<label class="pan">',""!=c.icon&&(b+='<img src="'+
c.icon+'" width="22" height="22" class="icon" />'),b+="<span>"+c.label+'</span><input type="range" data-channel="'+c.channel+'" class="panInput" step="0.001" min="0" max="1" value="0.5" /></label>',b+="</div>";channelsDiv.innerHTML=b;for(let c of document.querySelectorAll(".volumeInput, .panInput"))c.addEventListener("input",sliderChange),c.addEventListener("touchstart",tapSlider),c.addEventListener("dblclick",resetSlider);channelInputs=[...document.getElementsByClassName("volumeInput")];panInputs=
[...document.getElementsByClassName("panInput")]}function onOpen(){document.body.classList.remove("disconnected")}function noConnection(){ws&&ws.close();clearTimeout(timeout);timeout=setTimeout(startWebsocket,2E3);document.body.classList.add("disconnected")}function startWebsocket(){ws=new WebSocket("ws://"+document.location.host);ws.onopen=onOpen;ws.onmessage=onMessage;ws.onclose=noConnection;ws.onerror=noConnection}
document.addEventListener("DOMContentLoaded",function(){panCheckbox.checked=!1;startWebsocket();auxSelect.addEventListener("change",function(a){localStorage.setItem("aux",this.value);a=this.getElementsByTagName("option")[this.selectedIndex].dataset.colour;document.body.style.setProperty("--tint",a);this.previousElementSibling.innerHTML=this.getElementsByTagName("option")[this.selectedIndex].text;this.previousElementSibling.previousElementSibling.src=this.getElementsByTagName("option")[this.selectedIndex].dataset.icon;
"true"==this.getElementsByTagName("option")[this.selectedIndex].dataset.stereo?panCheckbox.parentNode.style.display="flex":panCheckbox.parentNode.style.display="none";panCheckbox.checked=!1;panCheckbox.dispatchEvent(new Event("change"));for(let b of channelInputs)b.value=0,b.parentNode.style.setProperty("--value",100*b.value+"%");for(let b of panInputs)b.value=.5,b.parentNode.style.setProperty("--value",100*b.value+"%");requestValues()});panCheckbox.addEventListener("change",function(a){this.checked?
document.body.classList.add("panning"):document.body.classList.remove("panning")})});
